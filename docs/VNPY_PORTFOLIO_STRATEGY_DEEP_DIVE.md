# vn.py 组合策略系统深度解析

## 一、组合策略的基本概念和应用场景

**组合策略**是指同时交易多个相关合约，通过它们之间的价格关系来获取收益的交易方式。与传统单边投机不同，组合策略的核心在于捕捉合约间的价差或相对价格变化，而非单纯预测单边涨跌。

**核心特点：**
- 风险对冲：通过同时持有相反方向的仓位，降低单边市场风险
- 收益稳定：基于价差均值回归或趋势延续，收益相对稳定
- 资金效率：组合策略通常可以用较少资金撬动更大名义本金

**主要应用场景：**
1. **期货市场套利**：跨期套利、跨品种套利、期现套利
2. **股票市场配对交易**：基于统计相关性选择股票对进行交易
3. **外汇市场利差交易**：利用不同货币利率差异获利
4. **量化基金核心策略**：市场中性策略、多因子策略的重要组成部分

## 二、vn.py 组合策略系统的架构概述

vn.py 的组合策略系统建立在事件驱动架构之上，与单策略系统共享底层基础设施，但增加了多合约协同管理能力。

**架构层次：**

1. **接口层**：统一的数据接口（CtpGateway等）和多合约行情订阅
2. **策略层**：PortfolioStrategy 基类，负责组合策略的核心逻辑
3. **执行层**：统一订单管理，支持组合订单的拆分和协同执行
4. **风控层**：组合级别的风险监控，包括价差偏离、资金占用等

**核心组件：**
- **多合约管理器**：统一管理多个交易对象的行情、持仓、订单状态
- **价差计算引擎**：实时计算合约间的价差或比率
- **信号生成器**：基于价差指标生成交易信号
- **组合执行引擎**：协同执行多腿交易，确保对冲平衡

## 三、价差套利策略原理和实现要点

**策略原理：**
价差套利是指同时买卖相关合约，等待价差回归正常范围。价差通常围绕均值波动，当偏离超过阈值时建仓，回归时平仓。

**实现要点：**

1. **价差计算方式**
   - 绝对价差：Spread = Price_A - Price_B
   - 相对价差：Spread = Price_A / Price_B - 1
   - 对数价差：Spread = ln(Price_A) - ln(Price_B)

2. **统计特征分析**
   - 计算价差的历史均值和标准差
   - 确定合理的入场和出场阈值（如 ±2σ）
   - 监控价差的相关性稳定性

3. **仓位管理**
   - 按比例分配资金，确保两腿对冲平衡
   - 考虑合约乘数差异，调整下单数量
   - 动态调整仓位，适应市场波动变化

4. **执行技巧**
   - 优先选择流动性好的合约交易
   - 分批建仓，降低市场冲击
   - 使用限价单控制成交价格

## 四、跨期套利策略原理和实现要点

**策略原理：**
跨期套利利用同一品种不同到期月份合约之间的价差获利。远期合约通常包含持有成本（资金成本、仓储费用），价差应在合理范围内波动。

**实现要点：**

1. **合约选择**
   - 选择主力合约和次主力合约
   - 确保有足够流动性和持仓量
   - 注意交割月份的临近影响

2. **价差分析**
   - 计算理论价差（基于持有成本模型）
   - 监控实际价差与理论价差的偏离
   - 关注季节性因素对价差的影响

3. **资金管理**
   - 预留足够的保证金覆盖双倍持仓
   - 注意临近交割时保证金比例变化
   - 合理使用杠杆，避免爆仓风险

4. **风险控制**
   - 设置价差止损阈值，防止价差持续扩大
   - 控制单笔交易规模，分散风险
   - 监控基本面变化，及时调整策略

## 五、跨品种套利策略原理和实现要点

**策略原理：**
跨品种套利基于产业链关系或替代关系，交易两个相关品种的价差。例如：螺纹钢与铁矿石、豆粕与豆油。

**实现要点：**

1. **品种关系研究**
   - 分析产业链上下游关系
   - 计算品种间相关性系数
   - 研究历史价差规律

2. **对冲比例确定**
   - 基于价格波动率确定对冲比例
   - 考虑合约乘数差异
   - 动态调整对冲比例，适应市场变化

3. **基本面监控**
   - 关注供需关系变化
   - 监控政策影响
   - 跟踪库存、开工率等数据

4. **执行策略**
   - 选择流动性好的合约
   - 分散风险，避免单一品种过度集中
   - 设置止损止盈规则

## 六、组合管理的核心机制

**1. 多合约状态同步**
   - 统一管理多个合约的行情更新
   - 实时同步各腿的订单状态
   - 确保持仓数据的一致性

**2. 组合风险评估**
   - 计算组合的总体风险暴露
   - 监控价差偏离程度
   - 评估保证金占用情况

**3. 协同执行机制**
   - 支持组合订单的原子执行
   - 部分成交时的自动对冲调整
   - 异常情况下的自动平仓

**4. 动态再平衡**
   - 定期检查组合平衡状态
   - 根据市场变化调整仓位
   - 优化资金使用效率

## 七、风险控制要点

基于风险管理指南，组合策略需重点关注：

**1. 对冲失效风险**
   - 监控相关性变化，及时止损
   - 分散交易多个不相关的价差对
   - 设置最大亏损额度

**2. 执行风险**
   - 两腿成交时间差导致的风险暴露
   - 流动性不足导致的滑点
   - 网络延迟影响协同执行

**3. 资金风险**
   - 保证金占用增加，需预留充足资金
   - 价差扩大导致的保证金追缴
   - 极端行情下的爆仓风险

**4. 操作风险**
   - 合约到期换月操作
   - 手续费对收益的影响
   - 系统故障的应急预案

**具体控制措施：**
- 单个组合策略占用资金不超过总资金的30%
- 设置价差止损，单笔亏损不超过总资金的1%
- 保持组合多样性，避免过度集中
- 实时监控风险指标，达到阈值自动减仓

## 八、最佳实践建议

**1. 策略开发**
   - 从简单价差策略开始，逐步扩展
   - 充分回测，覆盖不同市场环境
   - 重视参数稳定性，避免过度优化

**2. 风险管理**
   - 严格执行风险控制规则
   - 定期评估策略表现，及时调整
   - 建立完善的异常处理机制

**3. 实盘运行**
   - 先模拟盘测试，验证策略有效性
   - 从小资金开始，逐步放大规模
   - 持续监控市场环境变化

**4. 代码质量**
   - 遵循模块化设计原则
   - 完善日志记录，便于问题排查
   - 编写清晰的文档和注释

**5. 持续优化**
   - 收集实盘数据，分析交易表现
   - 不断优化参数和逻辑
   - 学习新的套利机会和方法

## 九、简单配置示例

**价差套利策略配置示例：**

```
策略参数：
- symbol_a: "rb2405"      # 合约A
- symbol_b: "rb2410"      # 合约B
- window: 30             # 移动窗口
- entry_threshold: 2.0   # 入场阈值（标准差倍数）
- exit_threshold: 0.5    # 出场阈值（标准差倍数）
- fixed_size: 10         # 每手数量

资金管理：
- 单策略最大资金：100,000
- 保证金比例：15%
- 预留资金：30%

风险控制：
- 最大回撤：5%
- 止损额度：2,000
- 最大持仓时间：30天
```

**跨品种套利策略配置示例：**

```
策略参数：
- symbol_a: "m2405"       # 豆粕
- symbol_b: "y2405"       # 豆油
- hedge_ratio: 2.5       # 对冲比例
- window: 60
- entry_threshold: 2.5
- exit_threshold: 1.0
- fixed_size: 20

风险控制：
- 单策略最大资金：150,000
- 保证金比例：20%
- 止损额度：3,000
- 最大回撤：6%
```

## 总结

vn.py 的组合策略系统为量化交易提供了强大的套利能力。通过理解价差套利、跨期套利、跨品种套利的基本原理，遵循风险控制要点和最佳实践，结合 vn.py 的事件驱动架构，可以构建稳定、高效的组合策略。记住，套利交易的核心是风险管理而非收益最大化，严格遵守风控规则是长期成功的关键。
