# vn.py 策略开发最佳实践指南

## 一、策略设计原则

**1. 模块化设计**
将策略逻辑拆分为独立的功能模块，如信号生成、仓位管理、风险控制等。每个模块职责单一，便于测试和维护。

**2. 状态机思维**
策略应基于状态机设计，明确区分不同市场状态（趋势、震荡、突破等）下的行为。避免在单一函数中处理过多逻辑分支。

**3. 事件驱动优先**
充分利用 vn.py 的事件驱动架构，在 `on_tick`、`on_bar`、`on_order` 等回调函数中处理相应逻辑，避免轮询和阻塞操作。

**4. 可配置性**
策略参数应全部可配置，避免硬编码。使用 `parameters` 字典定义参数，便于回测和实盘调整。

## 二、代码组织结构

**1. 标准目录结构**
```
strategies/
├── base/              # 基础策略类
├── indicators/        # 自定义指标
├── utils/             # 工具函数
└── my_strategy.py     # 具体策略实现
```

**2. 类继承规范**
继承 `CtaTemplate` 基类，重写必要的方法：
- `__init__`: 初始化参数和变量
- `on_init`: 策略初始化
- `on_start`: 策略启动
- `on_stop`: 策略停止
- `on_tick/on_bar`: 核心交易逻辑

**3. 变量命名规范**
- 参数：`self.fixed_size`（小写+下划线）
- 变量：`self.long_pos`（小写+下划线）
- 常量：`MAX_POSITION`（大写+下划线）

## 三、参数管理方法

**1. 参数定义**
```python
parameters = {
    "fast_window": 10,
    "slow_window": 20,
    "fixed_size": 1,
    "sl_multiplier": 2.0
}
```

**2. 参数验证**
在 `on_init` 中验证参数合理性：
```python
if self.fast_window >= self.slow_window:
    raise ValueError("快线周期必须小于慢线周期")
```

**3. 参数持久化**
使用 `save_setting` 和 `load_setting` 方法保存和加载参数配置，避免重复输入。

**4. 参数优化**
结合 vn.py 的优化引擎，使用网格搜索或遗传算法优化参数组合。注意避免过拟合，使用样本外验证。

## 四、测试和调试技巧

**1. 单元测试**
对核心逻辑编写单元测试，使用 pytest 框架：
```python
def test_signal_generation():
    strategy = MyStrategy()
    assert strategy.generate_signal(...) == expected
```

**2. 回测验证**
- 使用历史数据进行充分回测
- 检查交易次数、胜率、最大回撤等指标
- 对比不同参数组合的表现
- 进行样本外测试验证策略稳定性

**3. 日志记录**
使用 vn.py 的日志系统记录关键信息：
```python
self.write_log(f"开多仓，价格：{tick.last_price}")
```
区分不同日志级别（DEBUG、INFO、WARNING、ERROR）。

**4. 可视化调试**
使用 vn.py 的图表功能可视化策略表现，检查信号生成、仓位变化等关键节点。

**5. 模拟盘测试**
实盘前必须经过模拟盘测试，验证策略在实时环境下的表现，检查滑点、延迟等实际因素。

## 五、风险控制建议

**1. 仓位管理**
- 单品种仓位不超过总资金的 20%
- 总持仓不超过总资金的 80%
- 使用金字塔加仓，避免一次性重仓

**2. 止损止盈**
- 每笔交易设置固定止损（如 2%）
- 达到目标利润后移动止损保护利润
- 设置最大单日亏损限制

**3. 风险指标监控**
实时监控以下指标：
- 最大回撤
- 夏普比率
- 胜率
- 盈亏比
- 连续亏损次数

**4. 异常处理**
```python
try:
    self.buy(tick.last_price, self.fixed_size)
except Exception as e:
    self.write_log(f"下单失败：{e}")
```

**5. 资金管理**
- 严格执行资金管理规则
- 避免情绪化交易
- 定期评估策略表现，及时调整或停止

**6. 技术风险**
- 网络断线处理：自动重连机制
- 数据异常处理：过滤异常价格
- 系统故障处理：设置紧急停止按钮

通过遵循以上最佳实践，可以显著提高 vn.py 策略的开发质量和实盘稳定性。记住，优秀的策略不仅在于盈利能力，更在于风险控制和长期可持续性。